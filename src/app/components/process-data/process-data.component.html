<div class="process-data-container">

    <div class="action-section" *ngIf="!hasProcessedFiles">
        <button class="primary" [disabled]="!hasSupplierFiles || isProcessing" (click)="processSupplierFiles()">
            {{ isProcessing ? 'Processing...' : 'Process Supplier Files' }}
        </button>
    </div>

    <div *ngIf="isProcessing" class="processing-message">
        <p>Processing supplier files, please wait...</p>
    </div>

    <div *ngIf="processedData.length > 0" class="data-table">
        <h2>Processed Data</h2>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-group">
                <label for="fileNameFilter">Filter by File Name ({{ availableFileNames.length }}):</label>
                <div class="dropdown-container">
                    <select id="fileNameFilter" [(ngModel)]="selectedFileName" (change)="onFileNameFilterChange()"
                        class="filter-dropdown">
                        <option value="">All Files</option>
                        <option *ngFor="let fileName of availableFileNames" [value]="fileName">{{ fileName }}</option>
                    </select>
                    <button type="button" *ngIf="selectedFileName" (click)="clearFileNameFilter()"
                        class="clear-dropdown-btn" title="Clear selection">×</button>
                </div>
            </div>

            <div class="filter-group">
                <label for="descriptionFilter">Filter by Description:</label>
                <div class="dropdown-container">
                    <select id="descriptionFilter" [(ngModel)]="selectedDescription"
                        (change)="onDescriptionFilterChange()" class="filter-dropdown">
                        <option value="">All Descriptions</option>
                        <option *ngFor="let desc of commonDescriptions" [value]="desc">{{ desc }}</option>
                    </select>
                    <button type="button" *ngIf="selectedDescription" (click)="clearDescriptionFilter()"
                        class="clear-dropdown-btn" title="Clear selection">×</button>
                </div>
            </div>

            <div class="filter-group">
                <label for="descriptionTextFilter">Search Description:</label>
                <input type="text" id="descriptionTextFilter" [(ngModel)]="descriptionTextFilter"
                    (input)="onDescriptionTextFilterChange()" placeholder="Enter text to search..."
                    class="filter-input">
            </div>

            <button type="button" (click)="clearFilters()" class="clear-filters-btn">Clear Filters</button>
        </div>

        <div class="results-info" *ngIf="filteredData.length > 0">
            <p>Showing {{ filteredData.length }} of {{ processedData.length }} results</p>
        </div>

        <table>
            <thead>
                <tr>
                    <th class="sortable-header" (click)="sortData('count')">
                        # {{ getSortIcon('count') }}
                    </th>
                    <th class="sortable-header" (click)="sortData('fileName')">
                        File Name {{ getSortIcon('fileName') }}
                    </th>
                    <th class="sortable-header" (click)="sortData('description')">
                        Description {{ getSortIcon('description') }}
                    </th>
                    <th class="sortable-header" (click)="sortData('unit')">
                        Unit {{ getSortIcon('unit') }}
                    </th>
                    <th class="sortable-header" (click)="sortData('price')">
                        Price {{ getSortIcon('price') }}
                    </th>
                </tr>
            </thead>
            <tbody>
                <ng-container *ngFor="let row of filteredData; let i = index">
                    <tr class="data-row" (click)="onRowClick(i)" [class.expanded]="isRowExpanded(i)">
                        <td>
                            <select [value]="row.count" (change)="onCountChange(i, $event)" class="count-dropdown"
                                (click)="$event.stopPropagation()">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </td>
                        <td>{{ row.fileName }}</td>
                        <td>{{ row.description }}</td>
                        <td>{{ row.unit }}</td>
                        <td>{{ row.price | currency }}</td>
                    </tr>

                    <!-- Expanded row showing original XLSX data -->
                    <tr *ngIf="isRowExpanded(i)" class="expanded-row">
                        <td colspan="5" class="expanded-content">
                            <div class="original-data-container">
                                <h4>Original Data from {{ row.fileName }}</h4>
                                <div class="original-data-table" *ngIf="row.originalData && row.originalHeaders">
                                    <table class="original-table">
                                        <thead>
                                            <tr>
                                                <th *ngFor="let header of row.originalHeaders">{{ header }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td *ngFor="let cellData of row.originalData">{{ cellData }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div *ngIf="!row.originalData || !row.originalHeaders" class="no-original-data">
                                    <p>Original data not available for this row.</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                </ng-container>
            </tbody>
        </table>
    </div>

    <div *ngIf="!hasSupplierFiles && processedData.length === 0" class="empty-state">
        <p>No supplier files uploaded yet. Please upload files on the Suppliers tab first.</p>
    </div>

    <div *ngIf="hasSupplierFiles && processedData.length === 0 && !isProcessing" class="empty-state">
        <p>Click "Process Supplier Files" to begin processing the uploaded files.</p>
    </div>

    <div *ngIf="processedData.length > 0 && filteredData.length === 0" class="empty-state">
        <p>No results match the current filters. Try adjusting your filter criteria.</p>
    </div>
</div>