<div class="rfq-container" [ngClass]="{ 'eos-theme': rfqState.selectedCompany === 'EOS' }">
    <div class="content-wrapper">
        <h1>Request for Quotation (RFQ)</h1>

        <div class="dropzone-container">
            <div class="dropzone" [class.drag-over]="isDragOver" (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)" (drop)="onDrop($event)" (click)="fileInput.click()">
                <div class="dropzone-content">
                    <span class="upload-icon" aria-hidden="true">ðŸ“‹</span>
                    <p class="dropzone-text">Captains Quotation Request</p>
                    <p class="dropzone-subtext">Drop Excel files here or click to browse</p>
                    <p class="dropzone-subtext">Only .xlsx, .xls, and .xlsm files are accepted</p>
                    <p class="dropzone-subtext">Uploaded files populate the Proposal tab automatically</p>
                </div>
            </div>
            <input #fileInput type="file" accept=".xlsx,.xls,.xlsm" multiple (change)="onFileSelected($event)"
                style="display: none;">
        </div>

        <div *ngIf="rfqState.isProcessing" class="processing-status">
            <div class="spinner"></div>
            <p>Processing Excel files...</p>
        </div>

        <div *ngIf="rfqState.errorMessage" class="error-message">
            <p>{{ rfqState.errorMessage }}</p>
        </div>

        <div *ngIf="rfqState.fileAnalyses.length > 0 && !rfqState.isProcessing" class="results-container">
            <div class="results-header">
                <h2>File Analysis Results</h2>
                <div class="header-actions">
                    <button class="clear-button" (click)="rfqState.clearAllFiles()">Clear All Files</button>
                </div>
            </div>

            <div class="results-table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Include</th>
                            <th>Tab Name</th>
                            <th>Top Left</th>
                            <th>#Rows</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Unit</th>
                            <th>Remark</th>
                            <th>Status</th>
                            <th class="remove-column-header">Remove</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let analysis of rfqState.fileAnalyses; let fileIndex = index">
                            <tr *ngFor="let tab of analysis.tabs; let isFirst = first; let tabIndex = index"
                                [class.file-first-row]="isFirst"
                                [class.excluded-row]="!tab.included"
                                [attr.data-file-index]="fileIndex"
                                [attr.data-tab-index]="tabIndex">
                                <td *ngIf="isFirst" [attr.rowspan]="analysis.tabs.length" class="file-name-cell" (click)="rfqState.openFile(analysis)">
                                    {{ analysis.fileName }}
                                </td>
                                <td class="exclude-cell">
                                    <input
                                        type="checkbox"
                                        [(ngModel)]="tab.included"
                                        (change)="rfqState.onIncludeChange(tab)"
                                        class="exclude-checkbox">
                                </td>
                                <td class="tab-name-cell" [class.hidden-tab]="tab.isHidden">
                                    {{ tab.tabName }}
                                    <span *ngIf="tab.isHidden" class="hidden-label">(Hidden)</span>
                                </td>
                                <td class="top-left-cell">
                                    <input
                                        type="text"
                                        [(ngModel)]="tab.topLeftCell"
                                        (input)="rfqState.onTopLeftCellChange($event, tab)"
                                        (blur)="rfqState.validateTopLeftCell(tab)"
                                        (focus)="rfqState.onTopLeftCellFocus($event, fileIndex, tabIndex)"
                                        [attr.list]="(!tab.topLeftCell || tab.topLeftCell.trim() === '') ? ('topLeftList-' + fileIndex + '-' + tabIndex) : null"
                                        [disabled]="!tab.included"
                                        class="top-left-input"
                                        placeholder="e.g., A1"
                                        maxlength="3"
                                        pattern="[A-Za-z][0-9]{1,2}">
                                    <datalist *ngIf="!tab.topLeftCell || tab.topLeftCell.trim() === ''" [attr.id]="'topLeftList-' + fileIndex + '-' + tabIndex">
                                        <option *ngFor="let cell of rfqState.getTopLeftCellOptionsLimited()" [value]="cell">{{ cell }}</option>
                                    </datalist>
                                </td>
                                <td class="row-count">{{ tab.rowCount }}</td>
                                <td class="product-cell">
                                    <select [(ngModel)]="tab.product" (change)="rfqState.onColumnChange(analysis, tab, 'product')" [disabled]="!tab.included" class="column-select">
                                        <option value="">-- Select --</option>
                                        <option *ngFor="let header of rfqState.getColumnOptions(tab)" [value]="header">{{ header }}</option>
                                    </select>
                                </td>
                                <td class="qty-cell">
                                    <select [(ngModel)]="tab.qty" (change)="rfqState.onColumnChange(analysis, tab, 'qty')" [disabled]="!tab.included" class="column-select">
                                        <option value="">-- Select --</option>
                                        <option *ngFor="let header of rfqState.getColumnOptions(tab)" [value]="header">{{ header }}</option>
                                    </select>
                                </td>
                                <td class="unit-cell">
                                    <select [(ngModel)]="tab.unit" (change)="rfqState.onColumnChange(analysis, tab, 'unit')" [disabled]="!tab.included" class="column-select">
                                        <option value="">-- Select --</option>
                                        <option *ngFor="let header of rfqState.getColumnOptions(tab)" [value]="header">{{ header }}</option>
                                    </select>
                                </td>
                                <td class="remark-cell">
                                    <select [(ngModel)]="tab.remark" (change)="rfqState.onColumnChange(analysis, tab, 'remark')" [disabled]="!tab.included" class="column-select">
                                        <option value="">-- Select --</option>
                                        <option *ngFor="let header of rfqState.getColumnOptions(tab)" [value]="header">{{ header }}</option>
                                    </select>
                                </td>
                                <td class="status-cell">
                                    <ng-container *ngIf="rfqState.isTabReady(tab); else statusIncomplete">
                                        <span class="status-icon ready" aria-label="Ready to generate table">âœ”</span>
                                    </ng-container>
                                    <ng-template #statusIncomplete>
                                        <span class="status-icon not-ready" aria-label="Missing required selections">âœ–</span>
                                    </ng-template>
                                </td>
                                <td class="actions-cell" *ngIf="isFirst" [attr.rowspan]="analysis.tabs.length">
                                    <button
                                        type="button"
                                        class="remove-file-button"
                                        (click)="rfqState.removeFile(fileIndex)">
                                        Remove
                                    </button>
                                </td>
                            </tr>
                        </ng-container>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



