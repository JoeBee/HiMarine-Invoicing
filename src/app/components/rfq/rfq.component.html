<div class="rfq-container">
    <div class="content-wrapper">
        <h1>Request for Quotation (RFQ)</h1>

        <!-- Dropzone for Excel file upload -->
        <div class="dropzone-container">
            <div class="dropzone" [class.drag-over]="isDragOver" (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)" (drop)="onDrop($event)" (click)="fileInput.click()">
                <div class="dropzone-content">
                    <span class="upload-icon" aria-hidden="true">ðŸ“‹</span>
                    <p class="dropzone-text">Captains Quotation Request</p>
                    <p class="dropzone-subtext">Drop Excel files here or click to browse</p>
                    <p class="dropzone-subtext">Only .xlsx, .xls, and .xlsm files are accepted</p>
                </div>
            </div>
            <input #fileInput type="file" accept=".xlsx,.xls,.xlsm" multiple (change)="onFileSelected($event)"
                style="display: none;">
        </div>

        <!-- Company Selection -->
        <div class="company-selection">
            <label class="radio-label">
                <input type="radio" name="company" value="HI US" [(ngModel)]="selectedCompany"
                    (change)="onCompanyChange('HI US')">
                <span>HI US</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="company" value="HI UK" [(ngModel)]="selectedCompany"
                    (change)="onCompanyChange('HI UK')">
                <span>HI UK</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="company" value="EOS" [(ngModel)]="selectedCompany"
                    (change)="onCompanyChange('EOS')">
                <span>EOS</span>
            </label>
        </div>

        <!-- Main Content Section -->
        <div class="main-content">
            <!-- Left Side - Our Company Details and Bank Details -->
            <div class="left-section">
                <!-- Our Company Details Section -->
                <div class="section-box">
                    <h2 class="section-title">Our Company Details</h2>
                    <div class="company-details">
                        <div class="detail-field">
                            <label>Name:</label>
                            <input type="text" [(ngModel)]="rfqData.ourCompanyName" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Address:</label>
                            <input type="text" [(ngModel)]="rfqData.ourCompanyAddress" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Address 2:</label>
                            <input type="text" [(ngModel)]="rfqData.ourCompanyAddress2" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>City:</label>
                            <input type="text" [(ngModel)]="rfqData.ourCompanyCity" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Country:</label>
                            <input type="text" [(ngModel)]="rfqData.ourCompanyCountry" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Phone:</label>
                            <input type="text" [(ngModel)]="rfqData.ourCompanyPhone" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Email:</label>
                            <input type="text" [(ngModel)]="rfqData.ourCompanyEmail" class="editable-field">
                        </div>
                    </div>
                </div>

                <!-- Bank Details Section -->
                <div class="section-box">
                    <h2 class="section-title">Bank Details</h2>
                    <div class="bank-details">
                        <div class="bank-field">
                            <label>Bank Name:</label>
                            <input type="text" [(ngModel)]="rfqData.bankName" class="editable-field">
                        </div>
                        <div class="bank-field">
                            <label>Bank Address:</label>
                            <input type="text" [(ngModel)]="rfqData.bankAddress" class="editable-field">
                        </div>
                        <div class="bank-field">
                            <label>IBAN:</label>
                            <input type="text" [(ngModel)]="rfqData.iban" class="editable-field">
                        </div>
                        <div class="bank-field">
                            <label>Swift Code:</label>
                            <input type="text" [(ngModel)]="rfqData.swiftCode" class="editable-field">
                        </div>
                        <div class="bank-field">
                            <label>Title on Account:</label>
                            <input type="text" [(ngModel)]="rfqData.accountTitle" class="editable-field">
                        </div>
                        <div class="bank-field" *ngIf="selectedCompany === 'HI US'">
                            <label>ACH Routing:</label>
                            <input type="text" [(ngModel)]="rfqData.achRouting" class="editable-field">
                        </div>
                        <div class="bank-field" *ngIf="selectedCompany === 'EOS'">
                            <label>Intermediary BIC:</label>
                            <input type="text" [(ngModel)]="rfqData.intermediaryBic" class="editable-field">
                        </div>
                    </div>

                    <div class="uk-domestic-wires" *ngIf="selectedCompany === 'HI UK'">
                        <h3>UK DOMESTIC WIRES:</h3>
                        <div class="bank-field">
                            <label>Account number:</label>
                            <input type="text" [(ngModel)]="rfqData.accountNumber" class="editable-field">
                        </div>
                        <div class="bank-field">
                            <label>Sort code:</label>
                            <input type="text" [(ngModel)]="rfqData.sortCode" class="editable-field">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Vessel Details and Invoice Details -->
            <div class="right-section">
                <!-- Vessel Details Section -->
                <div class="section-box">
                    <h2 class="section-title">Vessel Details</h2>
                    <div class="vessel-details">
                        <div class="detail-field">
                            <label>Name:</label>
                            <input type="text" [(ngModel)]="rfqData.vesselName" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Name 2:</label>
                            <input type="text" [(ngModel)]="rfqData.vesselName2" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Address:</label>
                            <input type="text" [(ngModel)]="rfqData.vesselAddress" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Address 2:</label>
                            <input type="text" [(ngModel)]="rfqData.vesselAddress2" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>City:</label>
                            <input type="text" [(ngModel)]="rfqData.vesselCity" class="editable-field">
                        </div>
                        <div class="detail-field">
                            <label>Country:</label>
                            <input type="text" [(ngModel)]="rfqData.vesselCountry" class="editable-field">
                        </div>
                    </div>
                </div>

                <!-- Invoice Details Section -->
                <div class="section-box">
                    <h2 class="section-title">Invoice Details</h2>
                    <div class="invoice-details">
                        <div class="invoice-field">
                            <label>No</label>
                            <input type="text" [(ngModel)]="rfqData.invoiceNumber" class="editable-field">
                        </div>
                        <div class="invoice-field">
                            <label>Invoice Date</label>
                            <input type="date" [(ngModel)]="rfqData.invoiceDate" class="editable-field">
                        </div>
                        <div class="invoice-field">
                            <label>Vessel</label>
                            <input type="text" [(ngModel)]="rfqData.vessel" class="editable-field">
                        </div>
                        <div class="invoice-field">
                            <label>Country</label>
                            <select [(ngModel)]="rfqData.country" (ngModelChange)="onCountryChange()"
                                class="editable-field">
                                <option value="">Select Country</option>
                                <option *ngFor="let country of countries" [value]="country">{{ country }}</option>
                            </select>
                        </div>
                        <div class="invoice-field">
                            <label>Port</label>
                            <!-- Text input with datalist for suggestions -->
                            <input type="text" [(ngModel)]="rfqData.port" class="editable-field"
                                placeholder="Enter or select port name"
                                [attr.list]="availablePorts.length > 0 ? 'port-suggestions' : null">
                            <!-- Datalist for port suggestions when country is selected -->
                            <datalist *ngIf="availablePorts.length > 0" id="port-suggestions">
                                <option *ngFor="let port of availablePorts" [value]="port">
                            </datalist>
                        </div>
                        <div class="invoice-field">
                            <label>Category</label>
                            <input type="text" [(ngModel)]="rfqData.category" class="editable-field">
                        </div>
                        <div class="invoice-field">
                            <label>Invoice Due</label>
                            <select [(ngModel)]="rfqData.invoiceDue" class="editable-field">
                                <option value=""></option>
                                <option value="CASH">CASH</option>
                                <option value="CREDIT">CREDIT</option>
                                <option value="30 DAYS">30 DAYS</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing status -->
        <div *ngIf="isProcessing" class="processing-status">
            <div class="spinner"></div>
            <p>Processing Excel files...</p>
        </div>

        <!-- Error display -->
        <div *ngIf="errorMessage" class="error-message">
            <p>{{ errorMessage }}</p>
        </div>

        <!-- Results display -->
        <div *ngIf="fileAnalyses.length > 0 && !isProcessing" class="results-container">
            <div class="results-header">
                <h2>File Analysis Results</h2>
                <div class="header-actions">
                    <div class="header-buttons">
                        <button class="clear-button" (click)="clearAllFiles()">Clear All Files</button>
                        <button class="create-rfq-button" (click)="createRFQs()" [disabled]="!canCreateRFQs()">Create RFQs</button>
                    </div>
                    <p class="help-text">Create RFQs is disabled if there is no data or all four relevant columns have not been identified and tab has not been excluded</p>
                </div>
            </div>

            <div class="results-table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Exclude</th>
                            <th>Tab Name</th>
                            <th>Top Left</th>
                            <th>#Rows</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Unit</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let analysis of fileAnalyses; let fileIndex = index">
                            <tr *ngFor="let tab of analysis.tabs; let isFirst = first; let tabIndex = index"
                                [class.file-first-row]="isFirst"
                                [class.excluded-row]="tab.excluded"
                                [attr.data-file-index]="fileIndex"
                                [attr.data-tab-index]="tabIndex">
                                <td *ngIf="isFirst" [attr.rowspan]="analysis.tabs.length" class="file-name-cell" (click)="openFile(analysis)">
                                    {{ analysis.fileName }}
                                </td>
                                <td class="exclude-cell">
                                    <input 
                                        type="checkbox" 
                                        [(ngModel)]="tab.excluded" 
                                        (change)="onExcludeChange(tab)"
                                        class="exclude-checkbox">
                                </td>
                                <td class="tab-name-cell" [class.hidden-tab]="tab.isHidden">
                                    {{ tab.tabName }}
                                    <span *ngIf="tab.isHidden" class="hidden-label">(Hidden)</span>
                                </td>
                                <td class="top-left-cell">
                                    <input 
                                        type="text" 
                                        [(ngModel)]="tab.topLeftCell" 
                                        (input)="onTopLeftCellChange($event, tab)"
                                        (blur)="validateTopLeftCell(tab)"
                                        (focus)="onTopLeftCellFocus($event, fileIndex, tabIndex)"
                                        [attr.list]="(!tab.topLeftCell || tab.topLeftCell.trim() === '') ? ('topLeftList-' + fileIndex + '-' + tabIndex) : null"
                                        [disabled]="tab.excluded"
                                        class="top-left-input"
                                        placeholder="e.g., A1"
                                        maxlength="3"
                                        pattern="[A-Za-z][0-9]{1,2}">
                                    <datalist *ngIf="!tab.topLeftCell || tab.topLeftCell.trim() === ''" [attr.id]="'topLeftList-' + fileIndex + '-' + tabIndex">
                                        <option *ngFor="let cell of getTopLeftCellOptionsLimited()" [value]="cell">{{ cell }}</option>
                                    </datalist>
                                </td>
                                <td class="row-count">{{ tab.rowCount }}</td>
                                <td class="product-cell">
                                    <select *ngIf="tab.topLeftCell && tab.topLeftCell.trim() !== '' && tab.rowCount > 0" [(ngModel)]="tab.product" (change)="onColumnChange(analysis, tab, 'product')" [disabled]="tab.excluded" class="column-select">
                                        <option value="">-- Select --</option>
                                        <option *ngFor="let header of tab.columnHeaders" [value]="header">{{ header }}</option>
                                    </select>
                                    <span *ngIf="!tab.topLeftCell || tab.topLeftCell.trim() === '' || tab.rowCount === 0" class="no-dropdown-text">â€”</span>
                                </td>
                                <td class="qty-cell">
                                    <select *ngIf="tab.topLeftCell && tab.topLeftCell.trim() !== '' && tab.rowCount > 0" [(ngModel)]="tab.qty" (change)="onColumnChange(analysis, tab, 'qty')" [disabled]="tab.excluded" class="column-select">
                                        <option value="">-- Select --</option>
                                        <option *ngFor="let header of tab.columnHeaders" [value]="header">{{ header }}</option>
                                    </select>
                                    <span *ngIf="!tab.topLeftCell || tab.topLeftCell.trim() === '' || tab.rowCount === 0" class="no-dropdown-text">â€”</span>
                                </td>
                                <td class="unit-cell">
                                    <select *ngIf="tab.topLeftCell && tab.topLeftCell.trim() !== '' && tab.rowCount > 0" [(ngModel)]="tab.unit" (change)="onColumnChange(analysis, tab, 'unit')" [disabled]="tab.excluded" class="column-select">
                                        <option value="">-- Select --</option>
                                        <option *ngFor="let header of tab.columnHeaders" [value]="header">{{ header }}</option>
                                    </select>
                                    <span *ngIf="!tab.topLeftCell || tab.topLeftCell.trim() === '' || tab.rowCount === 0" class="no-dropdown-text">â€”</span>
                                </td>
                                <td class="remark-cell">
                                    <select *ngIf="tab.topLeftCell && tab.topLeftCell.trim() !== '' && tab.rowCount > 0" [(ngModel)]="tab.remark" (change)="onColumnChange(analysis, tab, 'remark')" [disabled]="tab.excluded" class="column-select">
                                        <option value="">-- Select --</option>
                                        <option *ngFor="let header of tab.columnHeaders" [value]="header">{{ header }}</option>
                                    </select>
                                    <span *ngIf="!tab.topLeftCell || tab.topLeftCell.trim() === '' || tab.rowCount === 0" class="no-dropdown-text">â€”</span>
                                </td>
                            </tr>
                        </ng-container>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

