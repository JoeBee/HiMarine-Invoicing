<div class="suppliers-container">
    <!-- <h1>Suppliers Docs</h1> -->

    <div class="drop-zones-container">
        <div class="drop-zone" [class.drag-over]="isDragging && hoveredDropzone === 'Bonded'"
            (dragover)="onDragOver($event, 'Bonded')" (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event, 'Bonded')" (click)="triggerFileInput('Bonded')">
            <div class="icon">ü™•ü•§üíß</div>
            <p><strong>Bonded</strong></p>
            <input type="file" id="fileInput-Bonded" multiple accept=".xlsx,.xls"
                (change)="onFileSelect($event, 'Bonded')" style="display: none;">
        </div>

        <div class="drop-zone" [class.drag-over]="isDragging && hoveredDropzone === 'Provisions'"
            (dragover)="onDragOver($event, 'Provisions')" (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event, 'Provisions')" (click)="triggerFileInput('Provisions')">
            <div class="icon">ü•©ü•ïüßÄ</div>
            <p><strong>Provisions</strong></p>
            <input type="file" id="fileInput-Provisions" multiple accept=".xlsx,.xls"
                (change)="onFileSelect($event, 'Provisions')" style="display: none;">
        </div>
    </div>

    <div class="drop-zone-instructions">
        <p>Drag and drop Excel files here or click to browse</p>
    </div>

    <!-- Price Divider and Process Controls -->
    <div class="controls-section">
        <div class="price-divider-group">
            <label for="priceDivider">Price Divider:</label>
            <input type="number" id="priceDivider" [(ngModel)]="priceDivider" (ngModelChange)="onPriceDividerChange()"
                step="0.01" min="0" max="999.99" placeholder="0.9" class="price-divider-input">
            <span class="price-divider-label">(e.g., 0.9 increases prices by ~11%)</span>
        </div>

        <div class="separate-fresh-provisions-group">
            <div class="toggle-container">
                <span class="toggle-label">{{ separateFreshProvisions ? 'Separate Fresh Provisions:' : 'Do not Separate Provisions' }}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="separateFreshProvisions" [(ngModel)]="separateFreshProvisions"
                        (ngModelChange)="onSeparateFreshProvisionsChange()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div *ngIf="isProcessing" class="processing-message">
        <p>Processing files...</p>
    </div>

    <div *ngIf="supplierFiles.length > 0" class="files-table">
        <div class="files-header">
            <h2>Uploaded Files ({{ supplierFiles.length }})</h2>
            <button class="secondary clear-button" (click)="clearAllFiles()">
                Clear All Files
            </button>
        </div>
        <table>
            <thead>
                <tr>
                    <th class="sortable-header" (click)="sortData('fileName')">
                        File Name {{ getSortIcon('fileName') }}
                    </th>
                    <th class="sortable-header" (click)="sortData('category')">
                        Category {{ getSortIcon('category') }}
                    </th>
                    <th class="sortable-header" (click)="sortData('topLeftCell')">
                        Top Left Cell {{ getSortIcon('topLeftCell') }}
                    </th>
                    <th class="sortable-header column-header-description" (click)="sortData('descriptionColumn')">
                        Description {{ getSortIcon('descriptionColumn') }}
                    </th>
                    <th class="sortable-header column-header-price" (click)="sortData('priceColumn')">
                        Price {{ getSortIcon('priceColumn') }}
                    </th>
                    <th class="sortable-header column-header-unit" (click)="sortData('unitColumn')">
                        Unit {{ getSortIcon('unitColumn') }}
                    </th>
                    <th class="sortable-header column-header-remarks" (click)="sortData('remarksColumn')">
                        Remarks {{ getSortIcon('remarksColumn') }}
                    </th>
                    <th class="sortable-header" (click)="sortData('rowCount')">
                        Row Count {{ getSortIcon('rowCount') }}
                    </th>
                    <th class="sortable-header status-header" (click)="sortData('status')">
                        Status {{ getSortIcon('status') }}
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let file of supplierFiles">
                    <td class="file-name-cell">
                        <span class="clickable-filename" (click)="openFile(file)">{{ file.fileName }}</span>
                        <button type="button" class="view-button" (click)="viewFilePreview(file)" [disabled]="!canPreviewFile(file)">
                            View
                        </button>
                    </td>
                    <td>{{ file.category || 'N/A' }}</td>
                    <td [class.not-found]="file.topLeftCell === 'NOT FOUND'">{{ file.topLeftCell }}</td>
                    <td class="column-description" [class.not-found]="file.descriptionColumn === 'NOT FOUND'">{{
                        file.descriptionHeader || file.descriptionColumn }}</td>
                    <td class="column-price" [class.not-found]="file.priceColumn === 'NOT FOUND'">{{ file.priceHeader
                        || file.priceColumn }}</td>
                    <td class="column-unit" [class.not-found]="file.unitColumn === 'NOT FOUND'">{{ file.unitHeader
                        || file.unitColumn }}</td>
                    <td class="column-remarks" [class.not-found]="file.remarksColumn === 'NOT FOUND'">{{ file.remarksHeader
                        || file.remarksColumn }}</td>
                    <td>{{ file.rowCount }}</td>
                    <td class="status-cell">
                        <span *ngIf="file.hasData === true" class="status-icon success">‚úì</span>
                        <span *ngIf="file.hasData === false" class="status-icon error">‚úó</span>
                        <span *ngIf="file.hasData === undefined" class="status-icon pending">-</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Custom Confirmation Dialog -->
    <div *ngIf="showConfirmDialog" class="modal-overlay" (click)="cancelClearAll()">
        <div class="confirmation-dialog" (click)="$event.stopPropagation()">
            <div class="dialog-header">
                <h3>‚ö†Ô∏è Confirm Clear All Files</h3>
            </div>
            <div class="dialog-content">
                <p>Are you sure you want to clear all uploaded files?</p>
                <p class="warning-text">This will also clear all processed data and cannot be undone.</p>
            </div>
            <div class="dialog-actions">
                <button class="secondary cancel-button" (click)="cancelClearAll()">
                    Cancel
                </button>
                <button class="danger confirm-button" (click)="confirmClearAll()">
                    Clear All Files
                </button>
            </div>
        </div>
    </div>

    <div *ngIf="previewDialogVisible" class="preview-dialog-container">
        <div class="preview-dialog-backdrop" (click)="closePreviewDialog()"></div>
        <div class="preview-dialog-content" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
            <div class="preview-dialog-header">
                <h3>Preview: {{ previewDialogFileName }}</h3>
                <div *ngIf="previewTopLeftHeader" class="preview-meta">
                    <span class="preview-meta-label">Top Left:</span>
                    <span class="preview-meta-value">{{ previewTopLeftHeader }}</span>
                </div>
                <button type="button" class="preview-close-button" (click)="closePreviewDialog()" aria-label="Close preview">√ó</button>
            </div>
            <ng-container *ngIf="previewDialogHeaders.length > 0; else noPreviewData">
                <div class="preview-dialog-body">
                    <table>
                        <thead>
                            <tr>
                            <th *ngFor="let header of previewDialogHeaders; let i = index"
                                [class.highlight-column]="isPreviewColumnHighlighted(i)">{{ header }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let row of previewDialogRows">
                            <td *ngFor="let cell of row; let i = index" [class.highlight-column]="isPreviewColumnHighlighted(i)">{{ cell }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </ng-container>
            <ng-template #noPreviewData>
                <div class="preview-dialog-body empty">
                    <p class="preview-empty-state">No preview data available for this file.</p>
                </div>
            </ng-template>
        </div>
    </div>
</div>